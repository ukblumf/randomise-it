{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% import "_macros.html" as macros %}
{% block page_content %}
    <h3>Hello{% if current_user.is_authenticated %}, {{ current_user.username }}{% else %}. Please create an account
        to harness the full power of The Randomist{% endif %}</h3>
    <div class="panel panel-default" id="info-panel">
        <div class="panel-heading">The wonderful world of Imagination driven by Randomness
            <button type="button" class="close pull-right" id="info-panel-close">
                <span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
            </button>
        </div>
        <div class="panel-body">At The Randomist we want to harness the power of randomness to drive creativity, that
            weird juxtaposition of concepts that spark an idea. That unusual hint that gets you to the next level in
            your story, scenario or idea.
            Or just randomly create a plot that your imagination has to explain.
            {% if not current_user.is_authenticated %}
                <br><br>Below is a random selection of some of the content on The Randomist.
                <br><br>Click on the Tables and Macros below to see output in the preview panel. <a id='register' href="{{ url_for('auth.register') }}">Create an account</a> to discover more.
            {% endif %}
        </div>
    </div>
    {% if current_user.is_authenticated %}
        <div class="container-fluid invisible" id="mainContent">
            <div class="row">
                <label for="tagFilter">Tag:</label>
                <select id="tagFilter">
                    <option label="" selected></option>
                    {% for tag in tags %}
                        <option label="{{ tag.id }}">{{ tag.id }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="row">
                <div class="col-md-4">
                    {{ macros.list_rows_in_table_header('story', current_user) }}
                    {{ macros.list_rows_in_table('story', stories, current_user) }}
                    {{ macros.list_rows_in_table_footer() }}
                </div>
                <div class="col-md-4">
                    {{ macros.list_rows_in_table_header('table', current_user) }}
                    {{ macros.list_rows_in_table('table', tables, current_user) }}
                    {{ macros.list_public_rows_in_table('table', public_tables) }}
                    {{ macros.list_rows_in_table_footer() }}

                </div>
                <div class="col-md-4">
                    {{ macros.list_rows_in_table_header('macro', current_user) }}
                    {{ macros.list_rows_in_table('macro', macro_list, current_user) }}
                    {{ macros.list_public_rows_in_table('macro', public_macros) }}
                    {{ macros.list_rows_in_table_footer() }}
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    {{ macros.list_rows_in_table_header('collection', current_user) }}
                    {{ macros.list_rows_in_table('collection', collections, current_user) }}
                    {{ macros.list_rows_in_table_footer() }}
                </div>
                <div class="col-md-4">
                    <div class="panel panel-default" style="margin-top: 40px">
                        <button type="button" class="close pull-right" id="preview-panel-clear">
                            <span aria-hidden="true">&times;</span><span class="sr-only">Clear</span>
                        </button>
                        <div class="panel-body" id="preview-panel">
                            <div><small class="text-muted">Click on Table or Macro, see results here.</small></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div>
            <div class="row">
                <div class="col-md-4">
                    <h1>Random Tables</h1>
                    <div>
                        <ul class="list-group" id="tableList">
                            {% for item in public_tables %}
                                <li class="list-group-item"
                                    {% if item.tags is defined %}data-tag="{{ item.tags }}{% endif %}">
                                    <button id="get-random-value"
                                            value="{{ url_for('.get_random_value', username=item.author.username, id=item.id) }}"
                                            class="btn btn-xs btn-primary">
                                        {{ item.name }}</button>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="col-md-4">
                    <h1>Macros</h1>
                    <div>
                        <ul class="list-group" id="macroList">
                            {% for item in public_macros %}
                                <li class="list-group-item"
                                    {% if item.tags is defined %}data-tag="{{ item.tags }}{% endif %}">
                                    <button id="get-macro-value"
                                            value="{{ url_for('.get_macro', username=item.author.username, id=item.id) }}"
                                            class="btn btn-xs btn-primary">{{ item.name }}</button>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="col-md-4">
                    <h1>Preview</h1>
                    <div class="panel panel-default">
                        <div class="panel-body" id="preview-panel">
                            <div><small class="text-muted">Click on Table or Macro, see results here.</small></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap.min.js"></script>
    <script>
        if (typeof Cookies.get('info-panel-close') !== 'undefined') {
            $("#info-panel").remove();
        }
        $.fn.dataTable.ext.search.push(
            function (settings, data, dataIndex) {
                const tag = $("#tagFilter").children("option:selected").val();
                const tag_field = data[1];
                if (tag == tag_field || tag == "") {
                    return true;
                }
                return false;
            }
        );
        $(document).ready(function () {
            $("button#get-random-value").click(function () {
                let url = $(this).val()
                const [ignore, username, id_type, id] = $(this).val().split("/");
                if ($(this).data('modifier') && $(this).data('modifier') != 'None') {
                    const modifier = prompt($(this).data('modifier'), "0");
                    if (modifier != null && !isNaN(modifier)) {
                        url += '?modifier=' + modifier;
                    }
                }
                $.ajax({
                    url: url, reference_id: id, success: function (result) {
                        result = result.replace(/(?:\r\n|\r|\n)/g, '<br>');
                        result = result.replace(/</g, '&lt;')
                        const el = '<div><small class="text-muted">' + this.reference_id + '</small><p>' + result + '</p></div>';
                        $("#preview-panel").prepend(el);
                    }
                });
            });

            $("button#get-macro-value").click(function () {
                const [ignore, username, id_type, id] = $(this).val().split("/");
                $.ajax({
                    url: $(this).val(), reference_id: id, success: function (result) {
                        result = result.replace(/(?:\r\n|\r|\n)/g, '<br>');
                        const el = '<div><small class="text-muted">' + this.reference_id + '</small><p>' + result + '</p></div>';
                        $("#preview-panel").prepend(el);
                    }
                });
            });

            $("button#info-panel-close").click(function () {
                $("#info-panel").remove();
                Cookies.set("info-panel-close", 'y')
            });
            $('#storyDataTable').DataTable({
                scrollY: "320px",
                scrollCollapse: true,
                pageLength: 25,
                lengthChange: false,
                dom: "<'row'<'col-sm-3'f><'col-sm-9'l>>" + "<'row'<'col-sm-12'tr>>" + "<'row'<'col-sm-5'i><'col-sm-7'p>>",
                language: {
                    "emptyTable": "no stories yet"
                },
                drawCallback: function (settings) {
                    var pagination = $(this).closest('.dataTables_wrapper').find('.dataTables_paginate');
                    pagination.toggle(this.api().page.info().pages > 1);
                }
            });
            let table_datatable = $('#tableDataTable').DataTable({
                scrollY: "320px",
                scrollCollapse: true,
                pageLength: 25,
                lengthChange: false,
                dom: "<'row'<'col-sm-3'f><'col-sm-9'l>>" + "<'row'<'col-sm-12'tr>>" + "<'row'<'col-sm-5'i><'col-sm-7'p>>",
                language: {
                    "emptyTable": "no tables"
                },
                drawCallback: function (settings) {
                    var pagination = $(this).closest('.dataTables_wrapper').find('.dataTables_paginate');
                    pagination.toggle(this.api().page.info().pages > 1);
                }
            });
            let macro_datatable = $('#macroDataTable').DataTable({
                scrollY: "320px",
                scrollCollapse: true,
                pageLength: 25,
                lengthChange: false,
                dom: "<'row'<'col-sm-3'f><'col-sm-9'l>>" + "<'row'<'col-sm-12'tr>>" + "<'row'<'col-sm-5'i><'col-sm-7'p>>",
                language: {
                    "emptyTable": "no macros"
                },
                drawCallback: function (settings) {
                    var pagination = $(this).closest('.dataTables_wrapper').find('.dataTables_paginate');
                    pagination.toggle(this.api().page.info().pages > 1);
                }
            });
            let collection_datatable = $('#collectionDataTable').DataTable({
                scrollY: "320px",
                scrollCollapse: true,
                pageLength: 25,
                lengthChange: false,
                dom: "<'row'<'col-sm-3'f><'col-sm-9'l>>" + "<'row'<'col-sm-12'tr>>" + "<'row'<'col-sm-5'i><'col-sm-7'p>>",
                language: {
                    "emptyTable": "no collections"
                },
                drawCallback: function (settings) {
                    var pagination = $(this).closest('.dataTables_wrapper').find('.dataTables_paginate');
                    pagination.toggle(this.api().page.info().pages > 1);
                }
            });

            $("#tagFilter").change(function () {
                Cookies.set("index-tag", $(this).children("option:selected").val());
                table_datatable.draw();
                macro_datatable.draw();
                collection_datatable.draw();
            });

            if (typeof Cookies.get('index-tag') !== 'undefined') {
                if (Cookies.get('index-tag') != "") {
                    $("#tagFilter").val(Cookies.get('index-tag'));
                    $("#tagFilter").trigger('change');
                }
            }

            $("button#preview-panel-clear").click(function () {
                $("#preview-panel").html('<div><small class="text-muted">Click on Table or Macro, see results here.</small></div>');
            });

            $("#mainContent").removeClass("invisible");
        });
    </script>
{% endblock %}
