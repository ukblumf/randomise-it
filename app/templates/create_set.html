{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% import "_macros.html" as macros %}
{% block title %}Randomise iT - Create Set{% endblock %}

{% block page_content %}
<div class="container-fluid">
	<div class="row">
		<div class="col-md-8">
            {% if current_user.can(Permission.WRITE_ARTICLES) %}
            <div id="editor">
            </div>
            {{ wtf.quick_form(form) }}
            {% endif %}
		</div>
		<div class="col-md-4">
            <h2>Random Tables</h2>
            <input class="form-control" id="tableFilter" type="text" placeholder="Search..">
            <div style="height: 200px; overflow-y: scroll;">
                <ul class="list-group" id="tableList">
                    {% for table in tables %}
                    <li class="list-group-item">
                        <button onclick="addId('table.{{ table.id }}')">{{ table.name }}</button>
                    </li>
                    {% endfor %}
                </ul>
            </div>
           <h2>Macros</h2>
            <input class="form-control" id="macroFilter" type="text" placeholder="Search..">
            <div style="height: 200px; overflow-y: scroll;">
                <ul class="list-group" id="macroList">
                    {% for macro in macro_list %}
                    <li class="list-group-item">
                        <button onclick="addId('macro.{{ macro.id }}')">{{ macro.name }}</button>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <h2>Sets</h2>
            <input class="form-control" id="setFilter" type="text" placeholder="Search..">
            <div style="height: 200px; overflow-y: scroll;">
                <ul class="list-group" id="setList">
                    {% for set in sets %}
                    <li class="list-group-item">
                        <button onclick="addId('set.{{ set.id }}')">{{ set.name }}</button>
                    </li>
                    {% endfor %}
                </ul>
            </div>
 		</div>
	</div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
        integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
        crossorigin="anonymous">
</script>
<script>
    function addId(id) {
        document.getElementById("{{ form_type }}_definition").value += id + '\n';
        document.getElementById("{{ form_type }}_definition").focus();
    }
    function split( val ) {
      return val.split( /\n/ );
    }
    function extractLast( term ) {
      return split( term ).pop();
    }
$(function() {
var availableTags = [
{% for table in tables %}"table.{{ table.id }}",{% endfor %}
{% for macro in macro_list %}"macro.{{ macro.id }}",{% endfor %}
{% for set in sets %}"set.{{ set.id }}",{% endfor %}
];

$(document).ready(function(){
    $("#tableFilter").on("keyup", function() {
        var value = $(this).val().toLowerCase();
        $("#tableList li").filter(function() {
          $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
    });

    $("#macroFilter").on("keyup", function() {
        var value = $(this).val().toLowerCase();
        $("#macroList li").filter(function() {
          $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
    });

    $("#setFilter").on("keyup", function() {
        var value = $(this).val().toLowerCase();
        $("#setList li").filter(function() {
          $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
    });

    var name_form_field = $("#{{ form_type }}_name");
    var id_form_field = $("#{{ form_type }}_id");

    name_form_field.blur(function() {
    if ( !( id_form_field.val() ) ) {
        var slug_text = name_form_field.val();
        id_form_field.val(slugify( slug_text ));
    }
    });

    id_form_field.blur(function() {
    if ( id_form_field.val() ) {
        var id_exists_url = "{{ url_for('.id_exists', type=form_type, id='') }}" + id_form_field.val();

        $.ajax({url: id_exists_url, success: function(result){
            if (result == '1') {
                $("label[for='{{ form_type }}_id']").text("Identifier -- ERROR Identifier already exists");
            } else {
                $("label[for='{{ form_type }}_id']").text("Identifier");
            }
        }});
    }
    });

    $( "#set_definition" )
      // don't navigate away from the field on tab when selecting an item
      .bind( "keydown", function( event ) {
        if ( event.keyCode === $.ui.keyCode.TAB &&
            $( this ).autocomplete( "instance" ).menu.active ) {
          event.preventDefault();
        }
      })
      .autocomplete({
        minLength: 0,
        position: { my : "left top", at: "center top" },
        source: function( request, response ) {
          // delegate back to autocomplete, but extract the last term
          response( $.ui.autocomplete.filter(
            availableTags, extractLast( request.term ) ) );
        },
        focus: function() {
          // prevent value inserted on focus
          return false;
        },
        select: function( event, ui ) {
          var terms = split( this.value );
          // remove the current input
          terms.pop();
          // add the selected item
          terms.push( ui.item.value );
          // add placeholder to get the comma-and-space at the end
          terms.push( "" );
          this.value = terms.join( "\n" );
          return false;
        }
        });
    });
});
</script>
{% endblock %}

